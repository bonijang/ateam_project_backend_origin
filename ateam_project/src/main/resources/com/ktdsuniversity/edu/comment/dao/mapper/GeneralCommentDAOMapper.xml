<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ktdsuniversity.edu.generalpost.dao.GeneralCommentDAO">

    <resultMap type="com.ktdsuniversity.edu.generalpost.vo.GeneralCommentVO"
               id="generalCommentVOMap"
               autoMapping="true">
        <id column="GENERAL_COMMENT_ID" property="generalCommentId" />
        
               <!--  <association property="generalPostVO"
                     javaType="com.ktdsuniversity.edu.generalpost.vo.GeneralPostVO"
                     autoMapping="true">
                <id column="GENERAL_POST_ID" property="generalPostId" />
                </association> -->
     <association property="generalPostVO"
                     javaType="com.ktdsuniversity.edu.generalpost.vo.GeneralPostVO"
                     autoMapping="true">
                <id column="GENERAL_POST_ID" property="generalPostId" />
     </association>   
     <association property="generalMemberVO"
                     javaType="com.ktdsuniversity.edu.generalmember.vo.GeneralMemberVO"
                     autoMapping="true">
                <id column="GENERAL_MEMBER_EMAIL" property="generalMemberEmail" />
     </association>
       <!--  <association property="memberVO"
                     javaType="com.ktdsuniversity.edu.member.vo.MemberVO"
                     autoMapping="true">
                <id column="EMAIL" property="email" />            
        </association> -->
          <!--<association property="reportVO"
                     javaType="com.ktdsuniversity.edu.report.vo.ReportVO"
                     autoMapping="true">
                <id column="REPORT_ID" property="reportId" />            
        </association> -->
    </resultMap>
    <select id="getAllComments"
            parameterType="string"
            resultMap="generalCommentVOMap">
              SELECT GC.GENERAL_COMMENT_ID
             , GC.COMMENT_WRITER
             , GC.GENERAL_POST_ID
             , GC.COMMENT_CONTENT
             , GC.POST_DATE
             , GC.UPPER_COMMENT_ID
             , GC.LIKE_CNT
             , GC.DELETE_YN
          FROM GENERAL_COMMENT GC
         INNER JOIN GENERAL_POST GP 
            ON GC.GENERAL_POST_ID = GP.GENERAL_POST_ID 
         INNER JOIN COMMON_CODE CC
            ON GP.GENERAL_POST_ID =CC.CODE_ID 
         WHERE CC.CODE_ID LIKE'CC-20231023-000146';
         START WITH GC.UPPER_COMMENT_ID = 0
           AND GC.GENERAL_POST_ID=#{_parameter}
         CONNECT BY PRIOR GC.GENERAL_COMMENT_ID = GC.UPPER_COMMENT_ID
    </select>
    <select id="getOneComment"
            parameterType="string"
            resultMap="generalCommentVOMap">
       SELECT GC.GENERAL_COMMENT_ID
             , GC.COMMENT_WRITER
             , GC.GENERAL_POST_ID
             , GC.COMMENT_CONTENT
             , GC.POST_DATE
             , GC.UPPER_COMMENT_ID
             , GC.LIKE_CNT
             , GC.DELETE_YN
          FROM GENERAL_COMMENT GC
         INNER JOIN GENERAL_POST GP 
            ON GC.GENERAL_POST_ID = GP.GENERAL_POST_ID 
         WHERE GP.GENERAL_POST_ID = #{_parameter}
    </select>
    
    <insert id="createNewComment"
            parameterType="com.ktdsuniversity.edu.generalpost.vo.GeneralCommentVO">
        INSERT INTO GENERAL_COMMENT (
             , GENERAL_COMMENT_ID
		     , COMMENT_WRITER
		     , GENERAL_POST_ID
		     , COMMENT_CONTENT
		     , POST_DATE
		     , UPPER_COMMENT_ID
		     , LIKE_CNT
		     , DELETE_YN)
		VALUES (
		    'GC-'||TO_CHAR(SYSDATE,'YYYYMMDD')||'-'||LPAD(SEQ_GENERAL_COMMENT_PK.NEXTVAL,6,'0')
		     , #{commentWriterId}
		     , #{generalPostId}
		     , #{commentContent}
		     , SYSDATE
		     , #{upperCommentId}
		     , 0
		     , 'N')
            </insert>
    <delete id="deleteOneComment"
            parameterType="string">
       DELETE
         FROM GENERAL_COMMENT
        WHERE GENERAL_COMMENT_ID = #{_parameter}
    </delete>
    <update id="likeOneComment"
            parameterType="string">
        UPDATE GENERAL_COMMENT
           SET LIKE_CNT = LIKE_CNT + 1
         WHERE GENERAL_COMMENT_ID = #{_parameter}        
    </update>

  </mapper>
            